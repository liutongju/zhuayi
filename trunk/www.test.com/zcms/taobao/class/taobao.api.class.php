<?php/** * taobao.api.class.php     ZCMS 淘宝客API接口 *  * @copyright    (C) 2005 - 2010  ZCMS * @licenes      http://www.zcms.cc * @lastmodify   2010-11-22 * @author       zhuayi   * @QQ			 2179942 */class taobao{	private $format = 'json';		private $v = '2.0';		private $sign_method = 'HmacMD5';		public $method;		public $fields;		private $url = 'http://gw.api.taobao.com/router/rest?';		public $_array = array();		private $timeout = '2';		public $cache;	//------构造函数	function __construct()	{		global $app_key,$app_secret,$timeout,$app_nick,$taobao_cache_time;		$this->app_key = $app_key;		$this->app_secret = $app_secret;		$this->timeout = $timeout;		$this->app_nick = $app_nick;		$this->taobao_cache_time = $taobao_cache_time;	}		/*	 * 方法item_cats 获取签名	 */	function item_cats()	{			}		//淘宝系统参数数组	function paramarr()	{ 		$array = array(						//TOP分配给用户的SessionKey，自用型应用不需要传入该参数的；非自用型的应用对于需要用户授权的API必须要传入该参数，对于不需要用户授权的API则不必传入该参数。						'session'=>'',													//时间戳，格式为yyyy-MM-dd hh:mm:ss，例如：2008-01-25 20:23:30。淘宝API服务端允许客户端请求时间误差为10分钟。						'timestamp'=> date('Y-m-d H:i:s'),													//可选，指定响应格式。默认xml,目前支持格式为xml,json						'format'=> $this->format,													//TOP分配给应用的AppKey						'app_key'=> $this->app_key,													//API协议版本，可选值:2.0。						'v'=> $this->v,													//参数的加密方法选择，可选值是：md5,hmac。这个参数只存在于2.0中。						'sign_method'=>$this->sign_method,													//-API接口名称						'method'=>$this->method,													//需要返回的字段列表						'fields'=>$this->fields,												//淘宝用户昵称						'nick'=>$this->app_nick,						 );				return $array+$this->_array; 	}		//----返回api接口	function _return()	{		$array = $this->paramarr();		foreach ($array as $key=>$val)		{			if ($key != '' && $val !='')			{ 				$this->url .= $key.'='.urlencode($val).'&'; 			}		}		$this->url .='sign='.$this->sign();		return $this->file_get_open();	}		//-----远程抓取函数	function file_get_open()	{		$caches=0;		$cache = ZCMS_CACHE.$this->method.'.'.$this->cache.'.cache.php';		//----查询是否有缓存		if (file_exists($cache))		{			if (time()-filemtime($cache)<$this->taobao_cache_time)			{				$caches = 1;				$this->url = $cache;			}		}		$ctx = stream_context_create(array('http' => array('timeout' => $this->timeout)));				$result = @file_get_contents($this->url,0, $ctx);		if($result)		{			if ($caches == 0 )			{				//----写入缓存				write($cache,$result);			}			$result = json_decode($result,true);			if (!empty($result['error_response']))			{				echo '调用API出错,错误信息<pre>';				echo '调用参数->'.$this->url;				print_r($result);			}			//---转码			return $result;					}		else		{  			return false;		}	}		//签名函数 	function sign()	{ 		//$this->app_secret; 		$paramarr = $this->paramarr();		ksort($paramarr); 		foreach ($paramarr as $key => $val)		{		   if ($key !='' && $val !='')		   { 			  // $val = iconv('gbk','utf-8',$val);			   $this->app_secret .= $key.$val; 		   } 		} 		return  strtoupper(md5($this->app_secret));  //Hmac方式	}}?>