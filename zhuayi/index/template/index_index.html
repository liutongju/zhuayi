<?php echo $this->load_fun('getedit','body');?>

<button>提交</button><br>
<style type="text/css">
pre.prettyprint{border:1px #ccc solid;padding:5px;background:#f2f2f2;}
</style>
---------
<pre class="prettyprint lang-php">&lt;?php
/**
 * index.php     Zhuayi DB抽象类
 *
 * @copyright    (C) 2005 - 2010  Zhuayi
 * @licenes      http://www.zhuayi.net
 * @lastmodify   2010-10-27
 * @author       zhuayi
 * @QQ			 2179942
 * 
 * ------------------------------------------------
 * $this-&gt;load_class('db');
 * 
 * // 查询单条记录
 * $reset = $this-&gt;db-&gt;fetch('admin');
 * 
 * // 查询多条记录,默认为30条
 * $reset = $this-&gt;db-&gt;fetch_row('admin');
 * 
 * // 带判断条件查询多条
 * $this-&gt;db-&gt;fetch_row('admin',array('id'=&gt;'1'),' id desc',' 0,30');
 * 
 * // 链式调用方法,查询单条
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;show();
 * 
 * // 链式调用查询多条,并指定字段
 * $reset = $this-&gt;db-&gt;table(array('article','keyid , id , title '))-&gt;limit('0,30')-&gt;order(' id desc ')-&gt;show();
 *
 * // 链式调用查询多条,带复杂判断
 * $reset = $this-&gt;db-&gt;table('article')-&gt;limit('0,11')-&gt;where('id &gt; 100')-&gt;show();
 *
 * // 链式调用: 新增数据
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;add(array('password'=&gt;'2','username'=&gt;'zhuayi'));
 *
 * // 新增数据
 * $reset = $this-&gt;db-&gt;insert('admin',array('password'=&gt;'2','username'=&gt;'zhuayi'));
 *
 * // 链式调用: 编辑数据
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;where(array('id'=&gt;'3'))-&gt;edit(array('password'=&gt;'3','username'=&gt;'zhuayi'));
 *
 * // 链式调用: 编辑数据,自定义判断挑件
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;where('id = 2 ')-&gt;edit(array('password'=&gt;'{+}3','username'=&gt;'zhuayi'));
 *
 * // 链式调用: 查询总数
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;where(array('id'=&gt;'3'))-&gt;maxnum();
 *
 * // 查询总数
 * $reset = $this-&gt;db-&gt;maxnum('admin',array('id'=&gt;'3'));
 * //编辑数据
 * $reset = $this-&gt;db-&gt;update('admin',array('password'=&gt;time(),'username'=&gt;'zhuayi'),array('id'=&gt;'3'))
 *
 * // 链式调用: 删除数据
 * $reset = $this-&gt;db-&gt;table('admin')-&gt;where(array('id'=&gt;'3'))-&gt;del();
 *
 * // 删除数据
 * $reset = $this-&gt;db-&gt;delete('admin',' id &gt; 3');
 *
 * -------------------------------------------------
 */
//include_once dirname(__FILE__).'/mysql.class.php';

class db
{

	public $table;

	public $limit;

	public $order;

	public $where;

	public $list = true;

	public $fields = '*';

	var $querynum;

	/**
	 * 构造函数
	 * @param find $fields 数据库配置文件 
	 */
	function __construct($fields = array())
	{
		global $cache;

		extract($fields, EXTR_OVERWRITE);
		
		foreach ($fields as $key=&gt;$val)
		{
			$this-&gt;$key = $val;
		}

		/* 加载缓存类 */
		$this-&gt;cache = &amp; $cache;

		/* 定义表前缀 */
		define('T', $this-&gt;mysql_pre);

	}

	function link($act = '0')
	{
		if ($act == '0')
		{
			/* 连接主库 */
			$dbhost = $this-&gt;mysql_host_m.':'.$this-&gt;mysql_port;
		}
		else
		{
			/* 连接从库*/
			$dbhost = $this-&gt;mysql_host_s.':'.$this-&gt;mysql_port;
		}

		if(!$this-&gt;link = @mysql_connect($dbhost, $this-&gt;mysql_user, $this-&gt;mysql_pass))
		{
			$this-&gt;error('Can not connect to MySQL server');
		}

		/* 设置编码 */
		if($this-&gt;mysql_charset)
		{
			mysql_query("SET character_set_connection={$this-&gt;mysql_charset}, character_set_results={$this-&gt;mysql_charset}, character_set_client=binary", $this-&gt;link);
		}

		/* 选择数据库 */
		if($this-&gt;mysql_db)
		{
			mysql_select_db($this-&gt;mysql_db, $this-&gt;link);
		}

	}
	
	function error($str)
	{
		$title = '数据库出错...';
		$str = 'sql: '.$str.'&lt;br&gt;';
		$str .= 'error: '.mysql_error().'&lt;br&gt;';
		$str .= 'errno: '.mysql_errno();
		output::error($title,$str);
	}
	
	/**
	 * --------------------------------
	 * table 设置表名
	 *
	 * @param string $table 表明
	 * @return	$this
	 * --------------------------------
	 */
	function table($table)
	{
		$this-&gt;where = '';

		if (is_array($table))
		{

			$this-&gt;table = T.$table[0];
			$this-&gt;fields = $table[1];
		}
		else
		{
			$this-&gt;table = T.$table;
		}
		
		return $this;
	}

	/**
	 * --------------------------------
	 * _fields 得到该表所有字段
	 *
	 * @param array $array 
	 * @return	array
	 * --------------------------------
	 */
	function _fields($array)
	{
		
		foreach ($array as $key=&gt;$val)
		{
			$array[trim($key)] = trim($val);
		}

		$fields_key = 'cache_fields_'.$this-&gt;table;

		$table_fields = $this-&gt;cache-&gt;get($fields_key);

		if ($table_fields === false)
		{
			$table_fields = $this-&gt;query(' show fields from '.$this-&gt;table,1,true);
			$this-&gt;cache-&gt;set($fields_key,$table_fields,86400);
		}
		
		$fields = array_keys($array);
	
		$reset2 = array();
		foreach ($table_fields as $val)
		{
			if (in_array($val['Field'],$fields))
			{
				$reset2[$val['Field']] = addslashes($array[$val['Field']]);
			}
		}
		return $reset2;
	}

	/**
	 * ----------------------------------------------------------------
	 * limit 设置查询记录数
	 *
	 * @param string $limit 查询结果树,查询单数为空或者"1",查询列表" 0 , 30"
	 * @return $this
	 * ----------------------------------------------------------------
	 */ 
	function limit($limit = '')
	{
		if (empty($limit) || $limit == '1')
		{
			$this-&gt;list = true;
			$limit = ' 0 , 1 ';
		}
		else
		{
			$this-&gt;list = false;

			$limit = explode(',',$limit);

			if ($limit[0] &lt; 1 )
			{
				$limit[0] = 0;
			}
			if ($limit[1] &lt; 1 )
			{
				$limit[1] = 0;
			}

			$limit = implode(',',$limit);
		}
		
		$this-&gt;limit = ' limit '.$limit;

		return $this;
	}

	/**
	 * ---------------------------------------
	 * where 查询挑件
	 *
	 * @param string $where 查询条件,可为数组
	 * @return $this
	 * ---------------------------------------
	 */ 
	function where($where = '')
	{

		if (empty($where))
		{
			return $this;
		}
		elseif (is_array($where))
		{

			$where = $this-&gt;_fields($where);
			
			$where2 = array();
			foreach ($where as $key=&gt;$val)
			{
				
				/* 模糊搜索 */
				if (preg_match('/\{%(.*?)%\}/i',$val))
				{
					$val = preg_replace('/\{%(.*?)%\}/i','$1',$val);
					$where2[] = ' `'.$key."` like '%".$val."%'";
				}
				elseif (preg_match('/\{(.*?)\}/i',$val))
				{
					/* 大于 {&gt;} 小于{&lt;}  {in}*/
					$val = preg_replace('/\{(.*?)\}/i','$1',$val);
					$where2[] = ' `'.$key."` ".$val."";
				}
				else
				{
					$where2[] = ' `'.$key."` = '".$val."'";
				}
				
			}

			$where = implode(' and ',$where2);
		}

		if (!empty($where))
		{
			$this-&gt;where = ' where '.$where;
		}

		return $this;
	}

	/**
	 * ----------------------------------------------------------------
	 * order 结果排列顺序
	 *
	 * @param string $order 例子: id desc =&gt; order by id desc
	 * @return $this
	 * ----------------------------------------------------------------
	 */ 
	function order($order)
	{
		if (empty($order))
		{
			return $this;
		}

		$this-&gt;order = ' order by '.$order;
		
		return $this;	
	}

	/**
	 * ---------------------------------------
	 * show 查询结果
	 *
	 * @return $this
	 * ---------------------------------------
	 */
	function show()
	{
		if (empty($this-&gt;limit))
		{
			$this-&gt;limit = ' limit 0 , 1';
		}

		$sql =  "select ".$this-&gt;fields." from ".$this-&gt;table.$this-&gt;where.$this-&gt;order.$this-&gt;limit;

		$reset = $this-&gt;query($sql);
		return $reset;
	}

	/**
	 * ---------------------------------------
	 * fetch 封装的查询单条结果
	 *
	 * @return list
	 * ---------------------------------------
	 */
	function fetch($table,$where = '',$order = '')
	{
		return $this-&gt;table($table)-&gt;where($where)-&gt;order($order)-&gt;limit(1)-&gt;show();

	}

	/**
	 * ---------------------------------------
	 * fetch_show 封装的查询多条结果
	 *
	 * @return list
	 * ---------------------------------------
	 */
	function fetch_row($table,$where = '',$order = '',$limit = ' 0,30 ')
	{

		return $this-&gt;table($table)-&gt;where($where)-&gt;order($order)-&gt;limit($limit)-&gt;show();
	}

	/**
	 * ---------------------------------------
	 * insert 封装的插入记录
	 *
	 * @return 自增$id
	 * ---------------------------------------
	 */
	function insert($table,$array)
	{
		return $this-&gt;table($table)-&gt;add($array);
	}

	/**
	 * ---------------------------------------
	 * add 插入记录
	 *
	 * @return 自增$id
	 * ---------------------------------------
	 */
	function add($array)
	{
		$array = $this-&gt;_fields($array);

		$key = array_keys($array);
		$key = '( `'.implode('`,`',$key).'` ) ';

		$value = array_values($array);
		$value = "(' ".implode("','",$value)."' ) ";

		$sql = 'insert into '.$this-&gt;table.$key.' values '.$value;

		if ($this-&gt;query($sql)!== false)
		{
			return $this-&gt;insert_id();
		}
		else
		{
			return false;
		}

	}

	/**
	 * ---------------------------------------
	 * update 封装的修改记录
	 *
	 * @return void
	 * ---------------------------------------
	 */
	function update($table,$array,$where)
	{
		return $this-&gt;table($table)-&gt;where($where)-&gt;edit($array);
	}

	/**
	 * ---------------------------------------
	 * edit 修改记录
	 *
	 * @return void
	 * ---------------------------------------
	 */
	function edit($array)
	{
		$array = $this-&gt;_fields($array);

		if (empty($array))
		{
			return false;
		}

		$reg = '/\{(.*[+,-])\}/i';
		foreach ($array as $key=&gt;$val)
		{
			if (!preg_match($reg,$val))
			{
				$field[] = ' `'.$key."` = '".$val."' ";
			}
			else
			{
				$val = preg_replace($reg,' $1 ',$val);
				$field[] = ' `'.$key."` = ".' `'.$key."` ".$val."  ";
			}
			
		}

		$sql = 'update '.$this-&gt;table.' set '.implode(',',$field).$this-&gt;where;

		return $this-&gt;query($sql);
	}

	/**
	 * ---------------------------------------
	 * delete 封装的删除记录
	 *
	 * @return void
	 * ---------------------------------------
	 */
	function delete($table,$where)
	{
		return $this-&gt;table($table)-&gt;where($where)-&gt;del();
	}

	/**
	 * ---------------------------------------
	 * del 删除记录
	 *
	 * @return void
	 * ---------------------------------------
	 */
	function del()
	{
		$sql = " delete from ".$this-&gt;table.$this-&gt;where;

		$this-&gt;query($sql,1);
	}

	function maxnum($table = '',$where = '')
	{
		
		if (!empty($table))
		{
			$this-&gt;table($table);
		}
		if (!empty($where))
		{
			$this-&gt;where($where);
		}

		$sql = "select count(*) from ".$this-&gt;table.$this-&gt;where;
		$this-&gt;list = true;
		$reset = $this-&gt;query($sql);
		return $reset['count(*)'];
	}

	/**
	 * ---------------------------------------
	 * 返回查询结果
	 *
	 * @param object $query
	 * @param string $row
	 * @return mixed
	 * ---------------------------------------
	 */
	function result($query, $row = '')
	{
		$query = mysql_result($query, $row);
		return $query;
	}

	/**
	 * ---------------------------------------
	 * 返回自增ID
	 *
	 * @return int
	 * ---------------------------------------
	 */
	function insert_id()
	{
		return ($id = mysql_insert_id($this-&gt;link)) &gt;= 0 ? $id : $this-&gt;result($this-&gt;_query("SELECT last_insert_id()"), 0);
	}


	function _query($sql,$act = '')
	{
		$this-&gt;link($act,$act);

		if(!($query = mysql_query($sql, $this-&gt;link)))
		{
			return false;
		}
		else
		{
			return $query;
		}
	}

	/* 取单条信息 */
	function _fetch_row($query, $result_type = MYSQL_ASSOC)
	{
		return @mysql_fetch_array($query, $result_type);
	}

	/* 取多条信息 */
	function _fetch_array($query, $result_type = MYSQL_ASSOC)
	{
		$list = array();
		while ($row = @mysql_fetch_array($query, $result_type))
		{
			$list[] = $row;
		}
		return $list;
	}

	/**
	 * ---------------------------------------
	 * query 执行SQL
	 *
	 * @return void
	 * ---------------------------------------
	 */
	function query($sql,$act=0 , $list=false)
	{
		if (isset($_GET['db_debug']))
		{
			echo "\n&lt;!--\n sql: {$sql} \n--&gt;\n";
		}

		if (!$reset = $this-&gt;_query($sql,$act))
		{
			$this-&gt;error($sql);
		}

		if ($list === true)
		{
			$return = $this-&gt;_fetch_array($reset);
		}
		elseif ($this-&gt;list || empty($this-&gt;limit))
		{
			$return =  $this-&gt;_fetch_row($reset);
		}
		else
		{
						
			$return = $this-&gt;_fetch_array($reset);
		}
		$this-&gt;querynum++;

		return $return;
	}

	/**
	 * ---------------------------------------
	 * 关闭连接
	 *
	 * @return bool
	 * ---------------------------------------
	 */
	function close() {
		return mysql_close($this-&gt;link);
	}


}</pre>